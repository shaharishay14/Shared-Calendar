# Shared Calendar (Expo + Supabase)

A crossâ€‘platform React Native app (Expo) for sharing a calendar between two people. Create events with time ranges and locations, see a perâ€‘day agenda, and stay in sync via Supabase Realtime. Works offline with a local SQLite cache.

## Features

- Calendar with perâ€‘day selection and multiâ€‘dot markers by category
- Events list filtered by the selected date
- Add/Edit events
  - Start and end time (24â€‘hour)
  - Category (Work/Personal/Study/Other)
  - Creator (Me/Partner)
  - Location
    - Type an address and tap "Locate" to geocode to lat/lng
    - Optional map picker (reactâ€‘nativeâ€‘maps) with reverse geocoding
- Event card actions: Info (details + mini map + Waze), Edit, Delete
- Floating "New" button, and a scrollâ€‘toâ€‘top button on long lists
- Smooth scrolling: list scrolls under the calendar; calendar stays visible
- Realtime sync via Supabase; local cache via SQLite
- Optional device limit (max 2 devices) with Supabase Auth + device registration
- **Household Member Management**: Invite and manage multiple users who share the same calendar
- **Profile Management**: User profiles with avatar support and household member viewing

### ðŸ¤– AI Week Planner (NEW!)

- **AI-Powered Week Planning**: Uses OpenAI GPT models to analyze your weekly schedule and provide intelligent recommendations
- **Smart Travel Optimization**: Suggests optimal sleep locations, travel routes, and timing to minimize driving time
- **Public Transport Integration**: Recommends when to use Israeli railways and buses instead of driving
- **Rush Hour Avoidance**: AI considers Israeli traffic patterns (7:30-10:00, 15:00-19:00) and suggests alternatives
- **Interactive AI Chat**: Chat with your AI assistant about your week plan, ask for specific optimizations
- **Contextual Recommendations**: AI understands your relationship dynamics and suggests ways to maximize time together
- **Real Israeli Locations**: Optimized for travel between Kfar Saba, Beit Dagan, Rishon Lezion, and Nir Tzvi

## Tech Stack

- Expo SDK 53, React Native
- SQLite (expo-sqlite) for local cache
- Supabase (Postgres + Realtime + RLS)
- expo-location (geocoding)
- react-native-maps (optional map picker)
- **OpenAI API** (GPT-4o-mini/GPT-4o for AI planning)
- **Israeli Public Transport Data** (Railways, Bus routes)

## Requirements

- Node 18+
- Expo CLI (`npm i -g expo-cli`) or use `npx expo`
- Supabase project (URL + anon key)

## Environment Variables

Create a `.env` file at the project root:

```bash
EXPO_PUBLIC_SUPABASE_URL=https://<your-ref>.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
EXPO_PUBLIC_HOUSEHOLD_ID=<shared-id-or-uuid>
OPENAI_API_KEY=sk-your-openai-api-key-here
```

### AI Configuration

**Setup Steps:**

1. Add `OPENAI_API_KEY=sk-your-api-key` to your `.env` file (get one at [platform.openai.com](https://platform.openai.com))
2. Restart the development server (`npm start`)
3. Go to **Week Planner** â†’ **Settings**
4. Enable **AI Assistant** toggle
5. Test the connection

The AI uses GPT-4o-mini by default for cost-effectiveness. All AI parameters are pre-configured for optimal Israeli week planning.

**AI Features Include:**

- Intelligent week planning with personalized recommendations
- Travel optimization considering Israeli traffic patterns
- Public transport vs. car recommendations
- Sleep location optimization for couples
- Interactive chat for specific planning questions

Restart dev server after changes: `npx expo start -c`.

## Supabase Setup

1. Create table `public.events`:

```sql
create table if not exists public.events (
  id bigint generated by default as identity primary key,
  title text not null,
  start timestamptz not null,
  end timestamptz,
  location text,
  lat double precision,
  lng double precision,
  category text,
  createdBy text,
  householdId text not null,
  updatedAt timestamptz not null default now()
);
create index if not exists events_household_start_idx on public.events (householdId, start);
```

2. (Optional) Device registration table + trigger (enforce â‰¤ 2 devices):

```sql
create table if not exists public.household_devices (
  household_id text not null,
  user_id uuid not null references auth.users(id) on delete cascade,
  device_id text not null,
  inserted_at timestamptz not null default now(),
  primary key (household_id, device_id)
);

create or replace function public.ensure_device_limit() returns trigger language plpgsql as $$
begin
  if (select count(*) from public.household_devices where household_id = new.household_id) >= 2 then
    raise exception 'Device limit reached';
  end if;
  return new;
end$$;

drop trigger if exists trg_device_limit on public.household_devices;
create trigger trg_device_limit before insert on public.household_devices
for each row execute function public.ensure_device_limit();
```

3. Enable RLS and policies (Authâ€‘based household access):

```sql
alter table public.events enable row level security;
alter table public.household_devices enable row level security;

create policy "hd read own" on public.household_devices for select using (user_id = auth.uid());
create policy "hd insert own" on public.household_devices for insert with check (user_id = auth.uid());

create policy "events read household" on public.events for select using (
  exists (select 1 from public.household_devices d
          where d.household_id = "householdId" and d.user_id = auth.uid())
);
create policy "events write household" on public.events for insert with check (
  exists (select 1 from public.household_devices d
          where d.household_id = "householdId" and d.user_id = auth.uid())
);
-- duplicate pattern for update/delete
```

4. Create table `public.household_members` (for household member management):

```sql
create table if not exists public.household_members (
  id bigint generated by default as identity primary key,
  "householdId" text not null,
  "userId" text not null,
  name text not null,
  email text,
  avatar text,
  role text not null default 'member',
  "joinedAt" timestamptz not null default now(),
  "isActive" boolean not null default true,
  unique("householdId", "userId")
);
create index if not exists household_members_household_active_idx
on public.household_members("householdId", "isActive");

-- Enable RLS and basic policies
alter table public.household_members enable row level security;
create policy "Users can view household members" on public.household_members for select using (true);
create policy "Users can manage household members" on public.household_members for all using (true);
```

5. Realtime: enable for `public.events` and `public.household_members` in Database â†’ Replication â†’ Publications. (Optional: `alter table public.events replica identity full;`)

## Permissions (app.json)

- iOS: add to `expo.ios.infoPlist`:

```json
{
  "NSLocationWhenInUseUsageDescription": "Allow Shared Calendar to access your location to pick event locations."
}
```

- Android: ensure `expo.android.permissions` includes `ACCESS_COARSE_LOCATION` and `ACCESS_FINE_LOCATION`.

## Install & Run

```bash
npm install
npx expo start -c
```

Open in Expo Go (fastest), or build a dev client if you need native modules like maps.

## Build (EAS)

```bash
# Android preview
npx eas build -p android --profile preview
# iOS preview (requires Apple developer account)
npx eas build -p ios --profile preview
```

## Notes

- Map picker requires `react-native-maps` in your build; without it, the app falls back to address geocoding only.
- The app buffers realtime updates while you drag the list to prevent scroll jumps and restores position after updates.
- To strictly limit devices, use Signâ€‘In (Supabase Auth) + Device Register; the trigger blocks the third device.

## Scripts

- `npm start` â€” start Expo
- `npm run android` / `npm run ios` â€” run platform builds via Expo

## License

MIT (or your preferred license)
